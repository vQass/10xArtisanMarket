@page "/dashboard/shop"
@attribute [Authorize]

@using ArtisanMarket.Application.Models
@using ArtisanMarket.Application.Services
@using ArtisanMarket.BlazorApp.Components.Account
@using Microsoft.AspNetCore.Authorization
@inject IShopService ShopService
@inject NavigationManager NavigationManager
@inject IdentityRedirectManager RedirectManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILogger<ShopManagement> Logger

<PageTitle>Zarządzanie Sklepem - ArtisanMarket</PageTitle>

<div class="container mt-4">
    <h1 class="mb-4">Utwórz swój sklep</h1>

    @if (ViewModel.IsLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Ładowanie...</span>
            </div>
            <p class="mt-3">Sprawdzanie statusu sklepu...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
    {
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Błąd</h4>
            <p>@ViewModel.ErrorMessage</p>
        </div>
    }
    else
    {
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">Informacje o sklepie</h5>
                    </div>
                    <div class="card-body">
                        @if (ViewModel != null)
                        {
                            <EditForm Model="ViewModel" method="post" OnSubmit="CreateShopAsync" FormName="createShopForm">
                                <DataAnnotationsValidator />
                                <ValidationSummary class="text-danger" role="alert" />

                            @if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
                            {
                                <div class="alert alert-danger">
                                    @ViewModel.ErrorMessage
                                </div>
                            }

                            <div class="mb-3">
                                    <InputText id="ViewModel.Model.Name" class="form-control" @bind-Value="ViewModel.Model.Name" />
                                <label for="ViewModel.Model.Name" class="form-label">Nazwa sklepu <span class="text-danger">*</span></label>
                                <ValidationMessage For="() => ViewModel.Model.Name" />
                            </div>

                            <div class="mb-3">
                                    <InputTextArea id="ViewModel.Model.Description" class="form-control" rows="3" @bind-Value="ViewModel.Model.Description" />
                                <label for="ViewModel.Model.Description" class="form-label">Opis sklepu</label>
                                <ValidationMessage For="() => ViewModel.Model.Description" />
                                <div class="form-text">Krótki opis Twojego sklepu widoczny w katalogu.</div>
                            </div>

                            <div class="mb-3">
                                    <InputText id="ViewModel.Model.ContactEmail" class="form-control" @bind-Value="ViewModel.Model.ContactEmail" />
                                 <label for="ViewModel.Model.ContactEmail" class="form-label">Email kontaktowy</label>
                                <ValidationMessage For="() => ViewModel.Model.ContactEmail" />
                                <div class="form-text">Email używany do kontaktu z klientami.</div>
                            </div>

                            <div class="mb-3">
                                    <InputText id="ViewModel.Model.Phone" class="form-control" @bind-Value="ViewModel.Model.Phone" />
                                <label for="ViewModel.Model.Phone" class="form-label">Numer telefonu</label>
                                <ValidationMessage For="() => ViewModel.Model.Phone" />
                                <div class="form-text">Numer telefonu do kontaktu.</div>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary" disabled="@ViewModel.IsLoading">
                                    @if (ViewModel.IsLoading)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status">Tworzenie...</span>
                                    }
                                    else
                                    {
                                        <span>Utwórz sklep</span>
                                    }
                                </button>

                                <button type="button" class="btn btn-secondary" @onclick="CancelAsync" disabled="@ViewModel.IsLoading">
                                    Anuluj
                                </button>
                            </div>
                            </EditForm>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [SupplyParameterFromForm]
    private CreateShopViewModel ViewModel { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            ViewModel.IsLoading = true;
            StateHasChanged();

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (!user.Identity?.IsAuthenticated ?? true)
            {
                NavigationManager.NavigateTo("/auth/login");
                return;
            }

            var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userId))
            {
                ViewModel.ErrorMessage = "Nie udało się zidentyfikować użytkownika.";
                return;
            }

            // Sprawdź czy użytkownik już ma sklep
            var existingShop = await ShopService.GetUserShopAsync(userId);
            if (existingShop != null)
            {
                // Użytkownik już ma sklep, przekieruj do zarządzania
                NavigationManager.NavigateTo("/dashboard/shop/manage");
                return;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Błąd podczas inicjalizacji strony tworzenia sklepu");
            ViewModel.ErrorMessage = "Wystąpił błąd podczas ładowania strony. Spróbuj odświeżyć.";
        }
        finally
        {
            ViewModel.IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task CreateShopAsync()
    {
        // Walidacja formularza
        var isValid = ViewModel.Model.ContactEmail != null;
        if (!isValid)
        {
            return;
        }

        try
        {
            ViewModel.IsLoading = true;
            ViewModel.ErrorMessage = null;
            StateHasChanged();

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                ViewModel.ErrorMessage = "Nie udało się zidentyfikować użytkownika.";
                return;
            }

            // Używamy ViewModel.Model, ponieważ @bind-Value aktualizuje te wartości bezpośrednio
            await ShopService.CreateShopAsync(userId, ViewModel.Model);

            // Sukces - przekieruj do dashboardu z komunikatem
            RedirectManager.RedirectTo("");
        }
        catch (InvalidOperationException ex)
        {
            // Biznesowa reguła biznesowa - użytkownik już ma sklep
            Logger.LogWarning(ex, "Próba utworzenia drugiego sklepu przez użytkownika");
            ViewModel.ErrorMessage = ex.Message;
        }
        catch (NavigationException)
        {
            throw;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Błąd podczas tworzenia sklepu");
            ViewModel.ErrorMessage = "Wystąpił błąd podczas tworzenia sklepu. Spróbuj ponownie.";
        }
        finally
        {
            ViewModel.IsLoading = false;
            StateHasChanged();
        }
    }

    private Task CancelAsync()
    {
        NavigationManager.NavigateTo("/dashboard");
        return Task.CompletedTask;
    }
}
